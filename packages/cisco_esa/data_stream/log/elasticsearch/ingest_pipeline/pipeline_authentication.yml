---
processors:
  - set:
      field: event.kind
      value: event
  - set:
      field: event.category
      value: [authentication]
  - grok:
      field: cisco_esa.log.message
      patterns:
        - "^GUI: User %{USERNAME:user.name} %{GREEDYDATA:cisco_esa.log.action} from session %{GREEDYDATA:cisco_esa.log.session} because of inactivity timeout"
        - "^CLI: User %{USERNAME:user.name} %{GREEDYDATA:cisco_esa.log.action} from %{GREEDYDATA:cisco_esa.log.session} because of inactivity timeout"
        - "^%{WORD:cisco_esa.log.action}:%{IP:host.ip} user:%{USERNAME:user.name} session:%{WORD:cisco_esa.log.session}"
        - "^User %{USERNAME:user.name} %{GREEDYDATA:cisco_esa.log.action} of %{WORD:network.protocol} session %{IP:host.ip}"
        - "^An authentication attempt by the user %{USERNAME:user.name} from %{IP:host.ip} %{WORD:cisco_esa.log.outcome} using an %{WORD:network.protocol} connection."
        - "^The user %{USERNAME:user.name} %{WORD:cisco_esa.log.outcome} %{GREEDYDATA:cisco_esa.log.action} from %{IP:host.ip} with privilege %{DATA:cisco_esa.log.privilege} using an %{WORD:network.protocol} connection."
        - "^User %{USERNAME:user.name} was %{WORD:cisco_esa.log.action} %{WORD:cisco_esa.log.outcome}."
        - "^User %{USERNAME:user.name} %{WORD:cisco_esa.log.outcome} %{WORD:cisco_esa.log.action}"
        - "^%{GREEDYDATA:cisco_esa.log.message}"
  - lowercase:
      field: network.protocol
      ignore_failure: true
  - set:
      field: event.outcome
      if: ctx?.cisco_esa?.log?.outcome == "failed"
      value: failure 
  - set:
      field: event.outcome
      if: ctx?.cisco_esa?.log?.outcome == "successfully"
      value: success 
  - set:
      field: event.type
      if: ctx?.cisco_esa?.log?.action == "logged on" || ctx?.cisco_esa?.log?.action == 'authenticated'
      value: [start] 
  - set:
      field: event.type
      if: ctx?.cisco_esa?.log?.action == 'logged out' || ctx?.cisco_esa?.log?.action == 'logout'
      value: [end]   
  - append:
      field: related.user
      value: "{{{user.name}}}"
      if: ctx?.user?.name != null
      allow_duplicates: false
      ignore_failure: true
  - append:
      field: related.ip
      value: "{{{host.ip}}}"
      if: ctx?.host?.ip != null
      allow_duplicates: false
      ignore_failure: true
